/**
 * Context React pour la gestion d'√©tat du chatbot multimodal OMA
 * 
 * Alternative √† Zustand utilisant React Context + useReducer
 * Conform√©ment au cahier des charges - objectif fluidit√© et performance
 * Gestion d'√©tat optimis√©e pour les interactions multimodales
 */

import React, { createContext, useContext, useReducer, useCallback, useRef } from 'react';

export interface ChatMessage {
  id: string;
  text: string;
  sender: 'user' | 'bot';
  timestamp: Date;
  isTyping?: boolean;
  embedding?: number[];
}

export interface ChatSuggestion {
  id: string;
  text: string;
  action: string;
  icon: string;
  type: 'whatsapp' | 'email' | 'appointment' | 'quote' | 'info';
}

interface ChatState {
  // √âtat de base
  messages: ChatMessage[];
  conversationId: string | null;
  
  // √âtats d'interaction
  isTyping: boolean;
  isSpeaking: boolean;
  isProcessingRAG: boolean;
  
  // Suggestions et proactivit√©
  suggestions: ChatSuggestion[];
  showSuggestions: boolean;
  lastInteractionTime: Date | null;
  
  // Gestion d'erreur
  error: string | null;
  retryCount: number;
  
  // Performance
  isVirtualized: boolean;
}

type ChatAction = 
  | { type: 'ADD_MESSAGE'; payload: Omit<ChatMessage, 'id' | 'timestamp'> }
  | { type: 'UPDATE_MESSAGE'; payload: { id: string; updates: Partial<ChatMessage> } }
  | { type: 'CLEAR_MESSAGES' }
  | { type: 'SET_TYPING'; payload: boolean }
  | { type: 'SET_RECORDING'; payload: boolean }
  | { type: 'SET_SPEAKING'; payload: boolean }
  | { type: 'SET_PROCESSING_RAG'; payload: boolean }
  | { type: 'SET_LISTENING'; payload: boolean }
  | { type: 'SET_AUDIO_LEVEL'; payload: number }
  | { type: 'SET_CONVERSATION_ID'; payload: string }
  | { type: 'RESET_CONVERSATION' }
  | { type: 'SET_SUGGESTIONS'; payload: ChatSuggestion[] }
  | { type: 'ADD_SUGGESTION'; payload: ChatSuggestion }
  | { type: 'CLEAR_SUGGESTIONS' }
  | { type: 'TOGGLE_SUGGESTIONS'; payload?: boolean }
  | { type: 'UPDATE_LAST_INTERACTION' }
  | { type: 'SET_ERROR'; payload: string | null }
  | { type: 'INCREMENT_RETRY' }
  | { type: 'RESET_RETRY' }
  | { type: 'ENABLE_VIRTUALIZATION' }
  | { type: 'DISABLE_VIRTUALIZATION' };

// Messages de bienvenue localis√©s pour le march√© s√©n√©galais
const WELCOME_MESSAGE: ChatMessage = {
  id: 'welcome-1',
  text: `Salut ! Je suis l'assistant IA d'OMA Digital ü§ñ

‚ú® Sp√©cialis√© dans l'automatisation pour PME s√©n√©galaises
üéØ +200% ROI moyen en 6 mois  
üè¢ 150+ clients √† Dakar
üöÄ Solutions IA sur mesure

Comment puis-je transformer votre business aujourd'hui ?

üí° Vous pouvez me parler ou √©crire !`,
  sender: 'bot',
  timestamp: new Date(),
  isVoice: false
};

// Suggestions par d√©faut contextualis√©es Dakar/S√©n√©gal
const DEFAULT_SUGGESTIONS: ChatSuggestion[] = [
  {
    id: 'suggest-1',
    text: 'Automatisation WhatsApp Business',
    action: 'Je veux automatiser WhatsApp pour mon commerce √† Dakar',
    icon: 'üí¨',
    type: 'whatsapp'
  },
  {
    id: 'suggest-2', 
    text: 'Site web ultra-rapide',
    action: 'Cr√©er un site web performant pour ma PME',
    icon: '‚ö°',
    type: 'quote'
  },
  {
    id: 'suggest-3',
    text: 'Devis personnalis√©',
    action: 'Je veux un devis pour digitaliser mon business',
    icon: 'üí∞',
    type: 'quote'
  },
  {
    id: 'suggest-4',
    text: 'Prendre RDV Dakar',
    action: 'Comment prendre rendez-vous dans vos bureaux √† Dakar ?',
    icon: 'üìÖ',
    type: 'appointment'
  }
];

const initialState: ChatState = {
  messages: [WELCOME_MESSAGE],
  conversationId: null,
  isTyping: false,
  isSpeaking: false,
  isProcessingRAG: false,
  suggestions: DEFAULT_SUGGESTIONS,
  showSuggestions: true,
  lastInteractionTime: null,
  error: null,
  retryCount: 0,
  isVirtualized: false
};

function chatReducer(state: ChatState, action: ChatAction): ChatState {
  switch (action.type) {
    case 'ADD_MESSAGE': {
      const newMessage: ChatMessage = {
        ...action.payload,
        id: `msg-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
        timestamp: new Date()
      };
      
      return {
        ...state,
        messages: [...state.messages, newMessage],
        error: null,
        lastInteractionTime: new Date()
      };
    }
    
    case 'UPDATE_MESSAGE':
      return {
        ...state,
        messages: state.messages.map(msg => 
          msg.id === action.payload.id 
            ? { ...msg, ...action.payload.updates }
            : msg
        )
      };
    
    case 'CLEAR_MESSAGES':
      return {
        ...state,
        messages: [WELCOME_MESSAGE],
        conversationId: null
      };
    
    case 'SET_TYPING':
      return { ...state, isTyping: action.payload };
    
    case 'SET_SPEAKING':
      return { ...state, isSpeaking: action.payload };
    
    case 'SET_PROCESSING_RAG':
      return { ...state, isProcessingRAG: action.payload };
    
    case 'SET_CONVERSATION_ID':
      return { ...state, conversationId: action.payload };
    
    case 'RESET_CONVERSATION':
      return {
        ...state,
        messages: [WELCOME_MESSAGE],
        conversationId: null,
        suggestions: DEFAULT_SUGGESTIONS,
        showSuggestions: true
      };
    
    case 'SET_SUGGESTIONS':
      return { ...state, suggestions: action.payload };
    
    case 'ADD_SUGGESTION':
      return {
        ...state,
        suggestions: [...state.suggestions, action.payload]
      };
    
    case 'CLEAR_SUGGESTIONS':
      return { ...state, suggestions: [] };
    
    case 'TOGGLE_SUGGESTIONS':
      return {
        ...state,
        showSuggestions: action.payload !== undefined 
          ? action.payload 
          : !state.showSuggestions
      };
    
    case 'UPDATE_LAST_INTERACTION':
      return { ...state, lastInteractionTime: new Date() };
    
    case 'SET_ERROR':
      return { ...state, error: action.payload };
    
    case 'INCREMENT_RETRY':
      return { ...state, retryCount: state.retryCount + 1 };
    
    case 'RESET_RETRY':
      return { ...state, retryCount: 0 };
    
    case 'ENABLE_VIRTUALIZATION':
      return { ...state, isVirtualized: true };
    
    case 'DISABLE_VIRTUALIZATION':
      return { ...state, isVirtualized: false };
    
    default:
      return state;
  }
}

interface ChatContextValue {
  state: ChatState;
  actions: {
    addMessage: (message: Omit<ChatMessage, 'id' | 'timestamp'>) => void;
    updateMessage: (id: string, updates: Partial<ChatMessage>) => void;
    clearMessages: () => void;
    setTyping: (typing: boolean) => void;
    setSpeaking: (speaking: boolean) => void;
    setProcessingRAG: (processing: boolean) => void;
    setConversationId: (id: string) => void;
    resetConversation: () => void;
    setSuggestions: (suggestions: ChatSuggestion[]) => void;
    addSuggestion: (suggestion: ChatSuggestion) => void;
    clearSuggestions: () => void;
    toggleSuggestions: (show?: boolean) => void;
    updateLastInteraction: () => void;
    setError: (error: string | null) => void;
    incrementRetry: () => void;
    resetRetry: () => void;
    enableVirtualization: () => void;
    disableVirtualization: () => void;
  };
  inactivityTimerRef: React.MutableRefObject<number | null>;
}

const ChatContext = createContext<ChatContextValue | null>(null);

export function ChatProvider({ children }: { children: React.ReactNode }) {
  const [state, dispatch] = useReducer(chatReducer, initialState);
  const inactivityTimerRef = useRef<number | null>(null);
  
  const actions = {
    addMessage: useCallback((message: Omit<ChatMessage, 'id' | 'timestamp'>) => {
      dispatch({ type: 'ADD_MESSAGE', payload: message });
    }, []),
    
    updateMessage: useCallback((id: string, updates: Partial<ChatMessage>) => {
      dispatch({ type: 'UPDATE_MESSAGE', payload: { id, updates } });
    }, []),
    
    clearMessages: useCallback(() => {
      dispatch({ type: 'CLEAR_MESSAGES' });
    }, []),
    
    setTyping: useCallback((typing: boolean) => {
      dispatch({ type: 'SET_TYPING', payload: typing });
    }, []),
    
    setSpeaking: useCallback((speaking: boolean) => {
      dispatch({ type: 'SET_SPEAKING', payload: speaking });
    }, []),
    
    setProcessingRAG: useCallback((processing: boolean) => {
      dispatch({ type: 'SET_PROCESSING_RAG', payload: processing });
    }, []),
    
    setConversationId: useCallback((id: string) => {
      dispatch({ type: 'SET_CONVERSATION_ID', payload: id });
    }, []),
    
    resetConversation: useCallback(() => {
      dispatch({ type: 'RESET_CONVERSATION' });
    }, []),
    
    setSuggestions: useCallback((suggestions: ChatSuggestion[]) => {
      dispatch({ type: 'SET_SUGGESTIONS', payload: suggestions });
    }, []),
    
    addSuggestion: useCallback((suggestion: ChatSuggestion) => {
      dispatch({ type: 'ADD_SUGGESTION', payload: suggestion });
    }, []),
    
    clearSuggestions: useCallback(() => {
      dispatch({ type: 'CLEAR_SUGGESTIONS' });
    }, []),
    
    toggleSuggestions: useCallback((show?: boolean) => {
      dispatch({ type: 'TOGGLE_SUGGESTIONS', payload: show });
    }, []),
    
    updateLastInteraction: useCallback(() => {
      // Nettoyer le timer pr√©c√©dent
      if (inactivityTimerRef.current) {
        clearTimeout(inactivityTimerRef.current);
      }
      
      // Nouveau timer de 30 secondes pour la proactivit√©
      inactivityTimerRef.current = window.setTimeout(() => {
        // Ajouter une relance proactive si pas d'interaction
        if (state.messages.length > 1 && !state.isTyping) {
          dispatch({
            type: 'ADD_MESSAGE',
            payload: {
              text: `Besoin d'aide suppl√©mentaire ? ü§ù

Je peux vous aider avec :
‚Ä¢ Automatisation WhatsApp Business
‚Ä¢ Sites web ultra-rapides (<1.5s)
‚Ä¢ Solutions IA sur mesure
‚Ä¢ Consultation gratuite

Que souhaitez-vous am√©liorer dans votre business ?`,
              sender: 'bot'
            }
          });
        }
      }, 30000); // 30 secondes comme sp√©cifi√©
      
      dispatch({ type: 'UPDATE_LAST_INTERACTION' });
    }, [state.messages.length, state.isTyping]),
    
    setError: useCallback((error: string | null) => {
      dispatch({ type: 'SET_ERROR', payload: error });
    }, []),
    
    incrementRetry: useCallback(() => {
      dispatch({ type: 'INCREMENT_RETRY' });
    }, []),
    
    resetRetry: useCallback(() => {
      dispatch({ type: 'RESET_RETRY' });
    }, []),
    
    enableVirtualization: useCallback(() => {
      dispatch({ type: 'ENABLE_VIRTUALIZATION' });
    }, []),
    
    disableVirtualization: useCallback(() => {
      dispatch({ type: 'DISABLE_VIRTUALIZATION' });
    }, [])
  };
  
  return (
    <ChatContext.Provider value={{ state, actions, inactivityTimerRef }}>
      {children}
    </ChatContext.Provider>
  );
}

export function useChatContext() {
  const context = useContext(ChatContext);
  if (!context) {
    throw new Error('useChatContext must be used within a ChatProvider');
  }
  return context;
}

/**
 * Hook pour les suggestions contextuelles bas√©es sur le message
 * Conforme aux objectifs de proactivit√© du cahier des charges
 */
export const useSmartSuggestions = () => {
  const { actions } = useChatContext();
  
  const generateSuggestions = useCallback((userMessage: string, botResponse: string) => {
    const lowerUserMsg = userMessage.toLowerCase();
    const lowerBotMsg = botResponse.toLowerCase();
    
    // Suggestions dynamiques bas√©es sur le contexte (micro-service interne)
    const suggestions: ChatSuggestion[] = [];
    
    if (lowerUserMsg.includes('whatsapp') || lowerBotMsg.includes('whatsapp')) {
      suggestions.push({
        id: `suggest-wa-${Date.now()}`,
        text: 'D√©mo WhatsApp Auto',
        action: 'Montrer une d√©mo de WhatsApp automatis√©',
        icon: 'üì±',
        type: 'whatsapp'
      });
    }
    
    if (lowerUserMsg.includes('prix') || lowerUserMsg.includes('co√ªt') || lowerBotMsg.includes('tarif')) {
      suggestions.push({
        id: `suggest-quote-${Date.now()}`,
        text: 'Devis d√©taill√©',
        action: 'Je veux un devis d√©taill√© avec pricing',
        icon: 'üí∞',
        type: 'quote'
      });
    }
    
    if (lowerUserMsg.includes('rdv') || lowerUserMsg.includes('rendez-vous') || lowerBotMsg.includes('rencontre')) {
      suggestions.push({
        id: `suggest-meeting-${Date.now()}`,
        text: 'Planifier RDV',
        action: 'Je veux planifier un rendez-vous √† Dakar',
        icon: 'üìÖ',
        type: 'appointment'
      });
    }
    
    // Ajouter les suggestions g√©n√©r√©es
    suggestions.forEach(suggestion => actions.addSuggestion(suggestion));
  }, [actions]);
  
  return { generateSuggestions };
};