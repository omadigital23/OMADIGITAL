#!/usr/bin/env node

/**
 * üîê Script de G√©n√©ration des Credentials Admin
 * 
 * Ce script g√©n√®re les valeurs n√©cessaires pour l'authentification admin :
 * - ADMIN_SALT : Un salt al√©atoire pour le hashing
 * - ADMIN_PASSWORD_HASH : Le hash s√©curis√© du mot de passe
 * 
 * Usage:
 *   node generate-admin-credentials.js
 *   node generate-admin-credentials.js VotreMotDePasse
 */

const crypto = require('crypto');
const readline = require('readline');

// Fonction pour hasher un mot de passe
function hashPassword(password, salt) {
  return crypto.pbkdf2Sync(password, salt, 10000, 64, 'sha512').toString('hex');
}

// Fonction pour valider la force du mot de passe
function validatePassword(password) {
  const errors = [];
  
  if (password.length < 8) {
    errors.push('‚ùå Le mot de passe doit contenir au moins 8 caract√®res');
  }
  if (!/[a-z]/.test(password)) {
    errors.push('‚ùå Le mot de passe doit contenir au moins une minuscule');
  }
  if (!/[A-Z]/.test(password)) {
    errors.push('‚ùå Le mot de passe doit contenir au moins une majuscule');
  }
  if (!/[0-9]/.test(password)) {
    errors.push('‚ùå Le mot de passe doit contenir au moins un chiffre');
  }
  if (!/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password)) {
    errors.push('‚ö†Ô∏è  Recommand√© : Ajoutez un caract√®re sp√©cial pour plus de s√©curit√©');
  }
  
  return errors;
}

// Fonction principale
async function generateCredentials() {
  console.log('\nüîê G√©n√©rateur de Credentials Admin\n');
  console.log('=' .repeat(60));
  
  // V√©rifier si un mot de passe a √©t√© pass√© en argument
  const passwordArg = process.argv[2];
  
  if (passwordArg) {
    // Mode non-interactif
    await processPassword(passwordArg);
  } else {
    // Mode interactif
    const rl = readline.createInterface({
      input: process.stdin,
      output: process.stdout
    });
    
    rl.question('\nüìù Entrez le mot de passe admin souhait√©: ', (password) => {
      rl.close();
      processPassword(password);
    });
  }
}

async function processPassword(password) {
  if (!password || password.trim() === '') {
    console.error('\n‚ùå Erreur: Le mot de passe ne peut pas √™tre vide\n');
    process.exit(1);
  }
  
  // Valider le mot de passe
  const errors = validatePassword(password);
  if (errors.length > 0) {
    console.log('\n‚ö†Ô∏è  Validation du mot de passe:\n');
    errors.forEach(err => console.log('  ' + err));
    console.log('');
    
    if (errors.some(e => e.startsWith('‚ùå'))) {
      console.error('‚ùå Le mot de passe ne respecte pas les exigences minimales\n');
      process.exit(1);
    }
  }
  
  // G√©n√©rer un salt al√©atoire (16 bytes = 32 caract√®res hex)
  const salt = crypto.randomBytes(16).toString('hex');
  
  // G√©n√©rer le hash du mot de passe
  const hash = hashPassword(password, salt);
  
  // Afficher les r√©sultats
  console.log('\n‚úÖ Credentials g√©n√©r√©s avec succ√®s!\n');
  console.log('=' .repeat(60));
  console.log('\nüìã Copiez ces valeurs dans vos variables d\'environnement:\n');
  console.log('ADMIN_USERNAME=admin');
  console.log(`ADMIN_SALT=${salt}`);
  console.log(`ADMIN_PASSWORD_HASH=${hash}`);
  console.log('\n' + '='.repeat(60));
  
  // Instructions
  console.log('\nüìñ Instructions:\n');
  console.log('1. Sur Vercel:');
  console.log('   - Allez dans Settings ‚Üí Environment Variables');
  console.log('   - Ajoutez les 3 variables ci-dessus');
  console.log('   - Red√©ployez votre application\n');
  
  console.log('2. Sur Netlify:');
  console.log('   - Allez dans Site settings ‚Üí Environment variables');
  console.log('   - Ajoutez les 3 variables ci-dessus');
  console.log('   - Red√©ployez votre site\n');
  
  console.log('3. En local (.env.local):');
  console.log('   - Ajoutez les 3 variables dans votre fichier .env.local');
  console.log('   - Red√©marrez votre serveur de d√©veloppement\n');
  
  // Avertissements de s√©curit√©
  console.log('üîí S√©curit√©:\n');
  console.log('   ‚ö†Ô∏è  Ne commitez JAMAIS ces valeurs dans Git');
  console.log('   ‚ö†Ô∏è  Ne les partagez pas publiquement');
  console.log('   ‚ö†Ô∏è  Stockez-les dans un gestionnaire de mots de passe');
  console.log('   ‚ö†Ô∏è  Changez le mot de passe r√©guli√®rement\n');
  
  // Informations techniques
  console.log('üìä Informations techniques:\n');
  console.log(`   - Salt length: ${salt.length} caract√®res (${Buffer.from(salt, 'hex').length} bytes)`);
  console.log(`   - Hash length: ${hash.length} caract√®res (${Buffer.from(hash, 'hex').length} bytes)`);
  console.log(`   - Algorithm: PBKDF2-SHA512 (10,000 iterations)`);
  console.log(`   - Password strength: ${getPasswordStrength(password)}\n`);
  
  console.log('=' .repeat(60));
  console.log('\n‚úÖ Configuration termin√©e!\n');
}

// Fonction pour √©valuer la force du mot de passe
function getPasswordStrength(password) {
  let score = 0;
  
  if (password.length >= 8) score++;
  if (password.length >= 12) score++;
  if (password.length >= 16) score++;
  if (/[a-z]/.test(password)) score++;
  if (/[A-Z]/.test(password)) score++;
  if (/[0-9]/.test(password)) score++;
  if (/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password)) score++;
  if (password.length >= 20) score++;
  
  if (score <= 3) return 'üî¥ Faible';
  if (score <= 5) return 'üü° Moyen';
  if (score <= 7) return 'üü¢ Fort';
  return 'üü¢ Tr√®s Fort';
}

// Ex√©cuter le script
generateCredentials().catch(error => {
  console.error('\n‚ùå Erreur:', error.message);
  process.exit(1);
});
