/**
 * Script pour lister tous les mod√®les Vertex AI disponibles
 * Usage: npx tsx scripts/list-available-models.ts
 */

import { GoogleAuth } from 'google-auth-library';
import * as dotenv from 'dotenv';

// Load environment variables
dotenv.config({ path: '.env.local' });

async function listAvailableModels() {
  console.log('üîç Recherche des mod√®les Vertex AI disponibles...\n');

  const projectId = process.env['GOOGLE_CLOUD_PROJECT_ID'];
  const location = process.env['GOOGLE_CLOUD_LOCATION'] || 'us-central1';

  if (!projectId) {
    console.error('‚ùå GOOGLE_CLOUD_PROJECT_ID non configur√©');
    process.exit(1);
  }

  console.log(`üìã Configuration:`);
  console.log(`   Project: ${projectId}`);
  console.log(`   Location: ${location}\n`);

  try {
    // Authenticate
    console.log('üîê Authentification...');
    const auth = new GoogleAuth({
      scopes: ['https://www.googleapis.com/auth/cloud-platform']
    });

    const client = await auth.getClient();
    const accessToken = await client.getAccessToken();

    if (!accessToken || !accessToken.token) {
      throw new Error('Failed to obtain access token');
    }

    console.log('‚úÖ Authentification r√©ussie\n');

    // Liste des mod√®les Gemini √† tester
    const modelsToTest = [
      'gemini-pro',
      'gemini-1.0-pro',
      'gemini-1.0-pro-001',
      'gemini-1.0-pro-002',
      'gemini-1.5-pro',
      'gemini-1.5-pro-001',
      'gemini-1.5-pro-002',
      'gemini-1.5-flash',
      'gemini-1.5-flash-001',
      'gemini-1.5-flash-002',
      'gemini-2.0-flash-exp',
      'text-bison',
      'text-bison-32k',
      'chat-bison',
      'chat-bison-32k'
    ];

    console.log('üß™ Test des mod√®les disponibles...\n');

    const availableModels: string[] = [];
    const unavailableModels: string[] = [];

    for (const model of modelsToTest) {
      process.stdout.write(`   Testing ${model.padEnd(30)} ... `);

      const url = `https://${location}-aiplatform.googleapis.com/v1/projects/${projectId}/locations/${location}/publishers/google/models/${model}:generateContent`;

      try {
        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${accessToken.token}`
          },
          body: JSON.stringify({
            contents: [{ parts: [{ text: 'Test' }] }],
            generationConfig: {
              temperature: 0.1,
              maxOutputTokens: 10
            }
          })
        });

        if (response.ok) {
          console.log('‚úÖ DISPONIBLE');
          availableModels.push(model);
        } else {
          const error = await response.json();
          if (error.error?.code === 404) {
            console.log('‚ùå Non trouv√©');
            unavailableModels.push(model);
          } else if (error.error?.code === 403) {
            console.log('‚ö†Ô∏è  Pas de permission');
            unavailableModels.push(model);
          } else {
            console.log(`‚ö†Ô∏è  Erreur ${error.error?.code || 'inconnue'}`);
            unavailableModels.push(model);
          }
        }
      } catch (error: any) {
        console.log(`‚ùå Erreur: ${error.message}`);
        unavailableModels.push(model);
      }

      // Petit d√©lai pour √©viter le rate limiting
      await new Promise(resolve => setTimeout(resolve, 200));
    }

    // R√©sum√©
    console.log('\n' + '='.repeat(60));
    console.log('üìä R√âSUM√â\n');

    if (availableModels.length > 0) {
      console.log('‚úÖ MOD√àLES DISPONIBLES:');
      availableModels.forEach(model => {
        console.log(`   ‚úì ${model}`);
      });
      console.log('');
    } else {
      console.log('‚ùå Aucun mod√®le disponible trouv√©\n');
    }

    if (unavailableModels.length > 0) {
      console.log('‚ùå MOD√àLES NON DISPONIBLES:');
      unavailableModels.forEach(model => {
        console.log(`   ‚úó ${model}`);
      });
      console.log('');
    }

    // Recommandation
    console.log('üí° RECOMMANDATION:\n');
    if (availableModels.length > 0) {
      const recommended = availableModels.find(m => m.includes('1.5-pro')) || 
                         availableModels.find(m => m.includes('1.5-flash')) ||
                         availableModels.find(m => m.includes('pro')) ||
                         availableModels[0];
      
      console.log(`   Utiliser: ${recommended}`);
      console.log(`\n   Dans pages/api/chat/gemini.ts, ligne 535:`);
      console.log(`   const url = \`https://\${location}-aiplatform.googleapis.com/v1/projects/\${projectId}/locations/\${location}/publishers/google/models/${recommended}:generateContent\`;\n`);
    } else {
      console.log('   ‚ö†Ô∏è  Aucun mod√®le disponible. V√©rifiez:');
      console.log('   1. Vertex AI API est activ√©e');
      console.log('   2. Billing est activ√©');
      console.log('   3. Service account a les permissions n√©cessaires\n');
    }

    console.log('='.repeat(60) + '\n');

  } catch (error) {
    console.error('\n‚ùå Erreur:', error);
    process.exit(1);
  }
}

// Run
listAvailableModels().catch(console.error);
