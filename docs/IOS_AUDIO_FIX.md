# üé§ Fix Audio STT pour iOS Safari

## Probl√®me

Le microphone du chatbot ne fonctionnait pas sur iPhone (iOS Safari et Chrome iOS), affichant "Erreur de reconnaissance vocale".

## Cause Racine

1. **Web Speech API non support√©**: iOS Safari ne supporte pas l'API `webkitSpeechRecognition` de mani√®re fiable
2. **Formats audio incompatibles**: iOS Safari enregistre en MP4/M4A au lieu de WebM/Opus
3. **Permissions microphone strictes**: iOS n√©cessite une gestion sp√©ciale des permissions
4. **MediaRecorder limitations**: iOS a des contraintes sur les formats et configurations audio

## Solution Impl√©ment√©e

### 1. Helper iOS Audio (`src/lib/utils/ios-audio-helper.ts`)

Nouveau module qui g√®re:
- ‚úÖ D√©tection iOS/Safari
- ‚úÖ S√©lection automatique du meilleur format audio support√©
- ‚úÖ Gestion des permissions microphone avec messages d'erreur clairs
- ‚úÖ Conversion audio optimis√©e pour l'API

**Formats support√©s par ordre de pr√©f√©rence**:
1. `audio/mp4` (iOS Safari)
2. `audio/aac` (iOS)
3. `audio/wav` (fallback)
4. `audio/webm;codecs=opus` (autres navigateurs)

### 2. Hook STT Am√©lior√© (`src/components/SmartChatbot/hooks/useSTT.ts`)

Modifications:
- ‚úÖ Utilise `requestMicrophonePermission()` pour iOS
- ‚úÖ D√©tecte automatiquement le meilleur format avec `getBestAudioFormat()`
- ‚úÖ Timeslice r√©duit √† 500ms sur iOS (vs 1000ms ailleurs)
- ‚úÖ Messages d'erreur sp√©cifiques iOS
- ‚úÖ Logs de debug pour diagnostiquer les probl√®mes

### 3. Backend STT Optimis√© (`src/lib/google-cloud-speech-service.ts`)

Am√©liorations:
- ‚úÖ D√©tection automatique du format audio (MP4, WAV, OGG, WebM)
- ‚úÖ Configuration dynamique de l'encoding Google Cloud Speech
- ‚úÖ Support des formats iOS (MP4/M4A ‚Üí MP3 encoding)
- ‚úÖ Fallback intelligent si format non reconnu

**Formats d√©tect√©s**:
```typescript
- MP4/M4A (iOS) ‚Üí encoding: 'MP3'
- WAV ‚Üí encoding: 'LINEAR16', sampleRate: 16000
- OGG ‚Üí encoding: 'OGG_OPUS'
- WebM ‚Üí encoding: 'WEBM_OPUS' (d√©faut)
```

## Architecture

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    iOS Safari / Chrome                       ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ  1. User clicks microphone button                           ‚îÇ
‚îÇ  2. requestMicrophonePermission() ‚Üí getUserMedia()          ‚îÇ
‚îÇ  3. getBestAudioFormat() ‚Üí audio/mp4 (iOS)                  ‚îÇ
‚îÇ  4. MediaRecorder records with optimal settings             ‚îÇ
‚îÇ  5. Audio blob sent to /api/stt/transcribe                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              API Route: /api/stt/transcribe                  ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ  1. Receives base64 audio data                              ‚îÇ
‚îÇ  2. Converts to ArrayBuffer                                 ‚îÇ
‚îÇ  3. Calls googleCloudSpeechService.transcribeAudio()        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         Google Cloud Speech Service (Backend)                ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ  1. Detects audio format from header bytes                  ‚îÇ
‚îÇ     - MP4/M4A (iOS) ‚Üí encoding: 'MP3'                       ‚îÇ
‚îÇ     - WAV ‚Üí encoding: 'LINEAR16'                            ‚îÇ
‚îÇ     - OGG ‚Üí encoding: 'OGG_OPUS'                            ‚îÇ
‚îÇ     - WebM ‚Üí encoding: 'WEBM_OPUS'                          ‚îÇ
‚îÇ  2. Calls Google Cloud Speech API                           ‚îÇ
‚îÇ  3. Returns { text, confidence, language }                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    Chatbot UI (Frontend)                     ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ  1. Displays transcription                                  ‚îÇ
‚îÇ  2. Sends to LLM for response                               ‚îÇ
‚îÇ  3. Plays TTS response                                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## Configuration Requise

### Variables d'Environnement

```bash
# Google Cloud API Key (pour STT/TTS)
GOOGLE_CLOUD_API_KEY=AIzaSyB3Kper2sR01N8fl0AxFqf_eEJ9jXVOApM
```

‚úÖ **D√©j√† configur√© dans `.env.local`**

### API Google Cloud

L'API utilise **Google Cloud Speech-to-Text API** avec API Key (pas Vertex AI).

**APIs activ√©es requises**:
- ‚úÖ Cloud Speech-to-Text API
- ‚úÖ Cloud Text-to-Speech API

## Test sur iOS

### √âtapes de Test

1. **Ouvrir sur iPhone**:
   ```
   https://omadigital.net (production)
   ou
   https://[votre-url-vercel].vercel.app (staging)
   ```

2. **Ouvrir le chatbot** (ic√¥ne en bas √† droite)

3. **Cliquer sur le bouton microphone** üé§

4. **Autoriser l'acc√®s au microphone** (popup iOS)

5. **Parler clairement** pendant 2-5 secondes

6. **V√©rifier la transcription** dans le chatbot

### Debug sur iOS

Pour voir les logs de debug:

1. **Safari iOS**: 
   - Connecter iPhone au Mac
   - Safari > Develop > [iPhone] > [Page]
   - Console pour voir les logs

2. **Chrome iOS**:
   - Utiliser Remote Debugging via Chrome DevTools

**Logs attendus**:
```javascript
üì± iOS Audio Capabilities: {
  isIOS: true,
  isSafari: true,
  mediaRecorderSupported: true,
  supportedFormats: ['audio/mp4', 'audio/aac'],
  recommendedFormat: { mimeType: 'audio/mp4', ... }
}

üé§ Format audio s√©lectionn√©: { mimeType: 'audio/mp4', ... }

‚úÖ MediaRecorder cr√©√© avec: {
  mimeType: 'audio/mp4',
  state: 'inactive'
}

üé§ Enregistrement d√©marr√© (timeslice: 500 ms)

üé§ STT Service: Transcribing with Vertex AI, size: 45678

üé§ D√©tect√©: Format MP4/M4A (iOS)

‚úÖ Google Cloud STT Success: {
  transcript: 'Bonjour, je voudrais...',
  confidence: 0.95,
  detectedLanguage: 'fr'
}
```

## Erreurs Courantes et Solutions

### 1. "Permission microphone refus√©e"

**Cause**: L'utilisateur a refus√© l'acc√®s au microphone

**Solution**:
- iOS: R√©glages > Safari > Microphone > Autoriser
- Chrome iOS: R√©glages > Chrome > Microphone > Autoriser

### 2. "Aucun microphone d√©tect√©"

**Cause**: Probl√®me mat√©riel ou microphone d√©sactiv√©

**Solution**:
- V√©rifier que le microphone fonctionne dans d'autres apps
- Red√©marrer l'iPhone

### 3. "Empty audio recording"

**Cause**: MediaRecorder n'a pas captur√© de donn√©es

**Solution**:
- Parler plus fort
- V√©rifier que le microphone n'est pas bloqu√©
- Essayer un timeslice plus long (d√©j√† optimis√© √† 500ms sur iOS)

### 4. "STT API error: 400"

**Cause**: Format audio non support√© par Google Cloud

**Solution**:
- Le code d√©tecte automatiquement le format
- Si probl√®me persiste, v√©rifier les logs pour voir le format d√©tect√©
- Ajouter un nouveau format dans la d√©tection si n√©cessaire

## Avantages de la Solution

1. ‚úÖ **Compatible iOS**: Fonctionne sur Safari et Chrome iOS
2. ‚úÖ **D√©tection automatique**: Pas besoin de configuration manuelle
3. ‚úÖ **Messages d'erreur clairs**: L'utilisateur sait quoi faire
4. ‚úÖ **Fallback intelligent**: Essaie plusieurs formats
5. ‚úÖ **Performance optimis√©e**: Timeslice adapt√© √† iOS
6. ‚úÖ **Logs de debug**: Facilite le diagnostic
7. ‚úÖ **Production-ready**: Gestion d'erreurs robuste

## Alternatives Consid√©r√©es

### ‚ùå Web Speech API (natif)
- **Probl√®me**: Non support√© sur iOS Safari
- **Rejet√©**: Pas fiable sur mobile

### ‚ùå Vertex AI Speech
- **Probl√®me**: N√©cessite Service Account (complexe)
- **Rejet√©**: Google Cloud API Key plus simple

### ‚úÖ Google Cloud Speech API (choisi)
- **Avantages**: Simple, API Key, supporte tous les formats
- **Inconv√©nient**: Co√ªt par requ√™te (mais acceptable)

## Co√ªt Estim√©

**Google Cloud Speech-to-Text**:
- Prix: $0.006 par 15 secondes
- 1000 requ√™tes de 5 secondes = ~$2
- Volume mensuel estim√©: 10,000 requ√™tes = ~$20/mois

**Optimisations**:
- Timeslice court (500ms) r√©duit la latence
- Cache TTS pour r√©duire les co√ªts
- Pas de transcription continue (seulement on-demand)

## Prochaines Am√©liorations

1. **Compression audio**: R√©duire la taille des fichiers avant envoi
2. **D√©tection de silence**: Arr√™ter automatiquement l'enregistrement
3. **Feedback visuel**: Waveform pendant l'enregistrement
4. **Multi-langue**: Support automatique de plus de langues
5. **Offline fallback**: Message si pas de connexion

## R√©f√©rences

- [Google Cloud Speech API](https://cloud.google.com/speech-to-text/docs)
- [MediaRecorder API](https://developer.mozilla.org/en-US/docs/Web/API/MediaRecorder)
- [iOS Safari Audio Limitations](https://webkit.org/blog/6784/new-video-policies-for-ios/)
- [Web Audio on Mobile](https://developers.google.com/web/fundamentals/media/recording-audio)

## Support

Pour toute question ou probl√®me:
1. V√©rifier les logs dans la console
2. Tester sur un autre appareil iOS
3. V√©rifier que l'API Key est valide
4. Contacter le support si le probl√®me persiste

---

**Derni√®re mise √† jour**: 13 octobre 2025
**Version**: 1.0.0
**Status**: ‚úÖ Production Ready
