# üîê Guide de Configuration des Variables d'Environnement

Ce guide vous aide √† configurer correctement votre fichier `.env.local` pour le projet OMADIGITAL.

---

## üìã Table des Mati√®res

1. [Variables Requises](#variables-requises)
2. [Variables Optionnelles](#variables-optionnelles)
3. [Configuration Locale](#configuration-locale)
4. [Configuration Vercel (Production)](#configuration-vercel-production)
5. [S√©curit√©](#s√©curit√©)

---

## ‚úÖ Variables Requises

### 1. Supabase (Base de donn√©es)

```bash
NEXT_PUBLIC_SUPABASE_URL=https://xxxxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

**O√π les trouver :**
1. Allez sur [supabase.com](https://supabase.com)
2. S√©lectionnez votre projet
3. **Settings** ‚Üí **API**
4. Copiez :
   - **Project URL** ‚Üí `NEXT_PUBLIC_SUPABASE_URL`
   - **anon public** ‚Üí `NEXT_PUBLIC_SUPABASE_ANON_KEY`
   - **service_role** (cliquez "Reveal") ‚Üí `SUPABASE_SERVICE_ROLE_KEY`

---

### 2. Google Vertex AI (Chatbot LLM, STT, TTS)

```bash
GOOGLE_APPLICATION_CREDENTIALS=./vertex-ai-credentials.json
GOOGLE_CLOUD_PROJECT=your-project-id
GOOGLE_CLOUD_LOCATION=us-central1
VERTEX_AI_MODEL=gemini-1.5-pro
VERTEX_AI_ENDPOINT=us-central1-aiplatform.googleapis.com
```

**‚ö†Ô∏è IMPORTANT : 100% Vertex AI uniquement**
- ‚ùå PAS de Google AI Studio (AI Studio Gemini)
- ‚ùå PAS de Hugging Face
- ‚ùå PAS de d√©tection de langue locale

**Comment configurer :**

1. **Cr√©er un Service Account :**
   - Allez sur [Google Cloud Console](https://console.cloud.google.com)
   - **IAM & Admin** ‚Üí **Service Accounts**
   - Cliquez sur **Create Service Account**
   - Nom : `vertex-ai-chatbot`
   - R√¥les requis :
     - `Vertex AI User`
     - `Cloud Speech Client`
     - `Cloud Text-to-Speech Client`

2. **T√©l√©charger les credentials :**
   - Cliquez sur le service account cr√©√©
   - **Keys** ‚Üí **Add Key** ‚Üí **Create new key**
   - Type : **JSON**
   - T√©l√©chargez le fichier
   - Renommez-le en `vertex-ai-credentials.json`
   - Placez-le √† la racine du projet

3. **Activer les APIs :**
   - Vertex AI API
   - Cloud Speech-to-Text API
   - Cloud Text-to-Speech API

---

### 3. Admin Authentication

```bash
ADMIN_USERNAME=admin_xxxxx
ADMIN_PASSWORD_HASH=xxxxx...
ADMIN_SALT=xxxxx...
JWT_SECRET=xxxxx...
```

**Comment g√©n√©rer :**

```bash
# G√©n√©rer les credentials admin
node generate-admin-credentials.js "VotreMotDePasse123!"

# G√©n√©rer JWT_SECRET
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
```

Le script `generate-admin-credentials.js` vous donnera :
- `ADMIN_USERNAME`
- `ADMIN_SALT`
- `ADMIN_PASSWORD_HASH`

---

## üîß Variables Optionnelles

### Google Analytics (Optionnel)

```bash
NEXT_PUBLIC_GA_ID=G-XXXXXXXXXX
```

### Monitoring (Optionnel)

```bash
NEXT_PUBLIC_PERFORMANCE_MONITORING=true
NEXT_PUBLIC_SECURITY_LEVEL=high
```

### Cron Jobs (Optionnel)

```bash
CRON_AUTH_TOKEN=your_random_token
```

---

## üíª Configuration Locale (D√©veloppement)

### √âtape 1 : Cr√©er `.env.local`

```bash
# Copier le template
cp .env.example .env.local
```

### √âtape 2 : Remplir les valeurs

Ouvrez `.env.local` et remplacez toutes les valeurs `your_xxx` par vos vraies credentials.

### √âtape 3 : V√©rifier

```bash
# Tester en local
npm run dev
```

Ouvrez http://localhost:3000 et testez :
- ‚úÖ Formulaire de contact (Supabase)
- ‚úÖ Newsletter (Supabase)
- ‚úÖ Chatbot (Vertex AI)
- ‚úÖ Admin login (JWT + Admin credentials)

---

## üöÄ Configuration Vercel (Production)

### √âtape 1 : Ajouter les Variables

1. Allez sur [vercel.com](https://vercel.com)
2. S√©lectionnez votre projet
3. **Settings** ‚Üí **Environment Variables**

### √âtape 2 : Ajouter chaque variable

**Format :**
- **Key** : Nom de la variable (ex: `NEXT_PUBLIC_SUPABASE_URL`)
- **Value** : Valeur de la variable
- **Environment** : ‚òëÔ∏è Production, ‚òëÔ∏è Preview, ‚òëÔ∏è Development

### √âtape 3 : Variables Vercel Requises

```
‚úÖ NEXT_PUBLIC_SUPABASE_URL
‚úÖ NEXT_PUBLIC_SUPABASE_ANON_KEY
‚úÖ SUPABASE_SERVICE_ROLE_KEY
‚úÖ GOOGLE_CLOUD_PROJECT
‚úÖ GOOGLE_CLOUD_LOCATION
‚úÖ VERTEX_AI_MODEL
‚úÖ VERTEX_AI_ENDPOINT
‚úÖ ADMIN_USERNAME
‚úÖ ADMIN_PASSWORD_HASH
‚úÖ ADMIN_SALT
‚úÖ JWT_SECRET
‚úÖ NODE_ENV (set to "production")
```

### √âtape 4 : Service Account JSON

Pour `GOOGLE_APPLICATION_CREDENTIALS`, vous avez 2 options :

**Option A : Variable d'environnement (Recommand√©)**
```
Key: GOOGLE_APPLICATION_CREDENTIALS_JSON
Value: [Coller tout le contenu du fichier vertex-ai-credentials.json]
```

Puis dans votre code, cr√©ez le fichier temporairement :
```typescript
if (process.env.GOOGLE_APPLICATION_CREDENTIALS_JSON) {
  const credentials = JSON.parse(process.env.GOOGLE_APPLICATION_CREDENTIALS_JSON);
  // Utiliser credentials
}
```

**Option B : Vercel Blob Storage**
Uploadez le fichier JSON sur Vercel Blob et r√©f√©rencez-le.

---

## üîí S√©curit√©

### ‚ùå Ne JAMAIS exposer c√¥t√© client :

- `SUPABASE_SERVICE_ROLE_KEY`
- `JWT_SECRET`
- `ADMIN_PASSWORD_HASH`
- `ADMIN_SALT`
- `CRON_AUTH_TOKEN`
- `vertex-ai-credentials.json`

### ‚úÖ Safe pour le client (NEXT_PUBLIC_*) :

- `NEXT_PUBLIC_SUPABASE_URL`
- `NEXT_PUBLIC_SUPABASE_ANON_KEY`
- `NEXT_PUBLIC_GA_ID`
- `NEXT_PUBLIC_BASE_URL`

### üõ°Ô∏è Bonnes Pratiques :

1. ‚úÖ Ajoutez `.env.local` et `vertex-ai-credentials.json` au `.gitignore`
2. ‚úÖ Ne commitez JAMAIS les credentials
3. ‚úÖ Utilisez des secrets diff√©rents pour dev/prod
4. ‚úÖ Rotez les credentials r√©guli√®rement
5. ‚úÖ Limitez les permissions du Service Account au minimum n√©cessaire

---

## üìù Checklist de V√©rification

### D√©veloppement Local

- [ ] `.env.local` cr√©√© et rempli
- [ ] `vertex-ai-credentials.json` t√©l√©charg√© et plac√© √† la racine
- [ ] Toutes les APIs Google Cloud activ√©es
- [ ] `npm run dev` fonctionne sans erreur
- [ ] Chatbot r√©pond correctement
- [ ] Admin login fonctionne
- [ ] Formulaires (contact, newsletter) fonctionnent

### Production Vercel

- [ ] Toutes les variables ajout√©es sur Vercel
- [ ] Service Account JSON configur√©
- [ ] D√©ploiement r√©ussi
- [ ] Site accessible
- [ ] Chatbot fonctionne en production
- [ ] Admin login fonctionne en production
- [ ] Formulaires fonctionnent en production

---

## üÜò D√©pannage

### Erreur : "Missing required environment variable"

**Solution :** V√©rifiez que toutes les variables requises sont d√©finies dans `.env.local` (local) ou Vercel (production).

### Erreur : "Invalid API key" (Supabase)

**Solution :** V√©rifiez que vous avez copi√© la cl√© compl√®te (tr√®s longue, commence par `eyJ...`).

### Erreur : "Vertex AI authentication failed"

**Solution :**
1. V√©rifiez que `vertex-ai-credentials.json` existe
2. V√©rifiez que le Service Account a les bons r√¥les
3. V√©rifiez que les APIs sont activ√©es

### Erreur : "Admin login failed"

**Solution :**
1. R√©g√©n√©rez les credentials avec `generate-admin-credentials.js`
2. V√©rifiez que `JWT_SECRET` est d√©fini (minimum 32 caract√®res)
3. V√©rifiez que les 3 variables admin sont correctes

---

## üìû Support

Pour toute question, consultez :
- Documentation Supabase : https://supabase.com/docs
- Documentation Vertex AI : https://cloud.google.com/vertex-ai/docs
- Documentation Next.js : https://nextjs.org/docs

---

**Derni√®re mise √† jour :** Octobre 2025
