<!DOCTYPE html>
<html>
<head>
    <title>Dashboard Data Flow Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button { padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background-color: #0056b3; }
        pre { background-color: #f8f9fa; padding: 10px; border-radius: 5px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>Dashboard Data Flow Test</h1>
    
    <button onclick="runTests()">Run Data Flow Tests</button>
    
    <div id="results"></div>

    <script>
        async function runTests() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<p>Running tests...</p>';
            
            try {
                // Test 1: Check if the dashboard API returns the correct data structure
                resultsDiv.innerHTML += '<div class="test-result info">1. Testing dashboard metrics API...</div>';
                const dashboardResponse = await fetch('/api/admin/dashboard-metrics');
                const dashboardData = await dashboardResponse.json();
                
                resultsDiv.innerHTML += `<div class="test-result info">Dashboard API Status: ${dashboardResponse.status}</div>`;
                resultsDiv.innerHTML += `<div class="test-result info">Dashboard Data Keys: ${Object.keys(dashboardData).join(', ')}</div>`;
                
                // Check for required properties
                const requiredProperties = [
                    'total_users',
                    'active_chats',
                    'total_conversations',
                    'avg_response_time',
                    'conversion_rate',
                    'total_quotes',
                    'blog_views',
                    'cta_clicks',
                    'total_blog_articles',
                    'total_subscribers'
                ];
                
                resultsDiv.innerHTML += '<div class="test-result info"><strong>Property Validation:</strong></div>';
                let allPropertiesExist = true;
                requiredProperties.forEach(prop => {
                    const exists = dashboardData.hasOwnProperty(prop);
                    const value = dashboardData[prop];
                    if (!exists) allPropertiesExist = false;
                    resultsDiv.innerHTML += `<div class="test-result ${exists ? 'success' : 'error'}">${prop}: ${exists ? 'âœ“' : 'âœ—'} (${value})</div>`;
                });
                
                // Test 2: Check if the metrics grid can handle the data without errors
                resultsDiv.innerHTML += '<div class="test-result info">2. Testing metrics grid data handling...</div>';
                
                // Simulate the metrics grid processing
                const metrics = [
                    {
                        title: 'Utilisateurs Totaux',
                        value: (dashboardData.total_users || 0).toLocaleString(),
                        icon: 'ðŸ‘¥',
                        color: 'text-blue-600',
                        bg: 'bg-blue-50'
                    },
                    {
                        title: 'AbonnÃ©s Newsletter',
                        value: (dashboardData.total_subscribers || 0).toLocaleString(),
                        icon: 'ðŸ“§',
                        color: 'text-emerald-600',
                        bg: 'bg-emerald-50'
                    }
                ];
                
                resultsDiv.innerHTML += '<div class="test-result info">Metrics grid processing simulation:</div>';
                metrics.forEach(metric => {
                    resultsDiv.innerHTML += `<div class="test-result success">${metric.title}: ${metric.value}</div>`;
                });
                
                resultsDiv.innerHTML += `<div class="test-result ${allPropertiesExist ? 'success' : 'error'}"><strong>Overall Test Result: ${allPropertiesExist ? 'PASSED' : 'FAILED'}</strong></div>`;
                
            } catch (error) {
                resultsDiv.innerHTML += `<div class="test-result error">Test failed: ${error.message}</div>`;
            }
        }
    </script>
</body>
</html>